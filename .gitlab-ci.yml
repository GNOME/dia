include:
  - project: "gnome/citemplates"
    file: "flatpak/flatpak_ci_initiative.yml"
  - component: gitlab.gnome.org/GNOME/citemplates/release-service@master
    inputs:
      dist-job-name: "flatpak@x86_64"
      tarball-artifact-path: "${TARBALL_ARTIFACT_PATH}"
  - component: "gitlab.gnome.org/GNOME/citemplates/gnomeos-basic-ci@master"
    inputs:
      before-script: "bash ./.gitlab-ci/gnomeos.sh"

.cache-paths: &cache-paths
  paths:
    - _ccache/

variables:
  APP_ID: "org.gnome.Dia"
  BUNDLE: "dia-dev.flatpak"
  FLATPAK_MODULE: "dia"
  GIT_SUBMODULE_STRATEGY: recursive
  MANIFEST_PATH: "build-aux/flatpak/org.gnome.Dia.json"
  RUNTIME_REPO: "https://nightly.gnome.org/gnome-nightly.flatpakrepo"

stages:
  - build
  - deploy

flatpak@x86_64:
  stage: build
  extends: ".flatpak@x86_64"

flatpak@aarch64:
  stage: build
  extends: ".flatpak@aarch64"

nightly@x86_64:
  extends: ".publish_nightly"
  needs: ["flatpak@x86_64"]

nightly@aarch64:
  extends: ".publish_nightly"
  needs: ["flatpak@aarch64"]

.mingw-defaults:
  stage: build
  tags:
    - win32-ps
  script:
    - C:\msys64\usr\bin\pacman --noconfirm -Syyuu
    - C:\msys64\usr\bin\bash -lc "bash -x ./.gitlab-ci/msys.sh"
  cache:
    key: "$CI_JOB_NAME"
    paths:
      - _ccache/
      - subprojects/xpm-pixbuf/

msys2-ucrt64:
  extends: .mingw-defaults
  needs: []
  variables:
    MSYSTEM: "UCRT64"
    CHERE_INVOKING: "yes"
